# Automating the Distribution of IBM Storage Protect Server Certificate to Clients

Self-signed SSL/TLS certificates generated by the IBM Storage Protect server expire after 10 years. The following process describes how to automate the distribution of a renewed certificate to IBM Storage Protect clients.

## Prerequisites

- The administrative client (`dsmadmc`) must be configured to connect to the server.
- A client scheduler must be set up for all clients (for scheduling details, refer to the [IBM Storage Protect scheduler overview](https://www.ibm.com/docs/en/storage-protect/8.1.25?topic=tasks-scheduling-overview)).
- Download the provided utility scripts on the admin client machine, based on the platform either from the directory `linux-aix-admin-client-script` or from `windows-admin-client-script`.
- The utility does **not** support clients registered as `OBJECTCLIENT` or `NAS`.


## Loading the Utility

- Set the environment based on the platform:
    - Use `cert_distribute.sh` for Linux/UNIX-based admin clients.
    - Use `cert_distribute.ksh` for AIX.
    - Use `cert_distribute.ps1` for Windows.
- Place the `cert_distribute.ini` configuration file in the same directory as the script.

| IBM Storage Protect Components | Minimum Version |
| :-- | :-- |
| IBM Storage Protect Server | 8.1.19 |
| IBM Storage Protect Client | 8.1.2 |

## About This Task

- Both **self-signed** and **CA-signed** certificates are supported, but [root and intermediate CA certificates must be distributed in order when used](https://www.ibm.com/docs/en/storage-protect/8.1.27?topic=certificates-installing-ca-signed).
- Ensure IBM GSkit (`gsk8capicmd_64`) is available at the default location for your platform:


| Platform | Default Directory |
| :-- | :-- |
| AIX | `/usr/opt/ibm/gsk8_64/bin/gsk8capicmd_64` |
| Linux | `/usr/local/ibm/gsk8_64/bin/gsk8capicmd_64` |
| Mac | `/Library/ibm/gsk8/bin/gsk8capicmd` |
| Windows | `C:\Program Files\IBM\gsk8\bin\gsk8capicmd_64` |

- The client keystore file `dsmcert.kdb` must be locatable by the script:
    - Defaults:
        - Linux: `/opt/tivoli/tsm/client/ba/bin`
        - Windows: `C:\Program Files\Tivoli\TSM\baclient`
        - Mac: `/Library/Application Support/tivoli/tsm/client/ba/bin`
        - AIX: `/usr/tivoli/tsm/client/ba/bin`
    - If not present, the script checks `DSM_DIR`, `PASSWORDDIR`, or user-specific directories.

> **Note:** The automation utility does **not** distribute new certificates to other servers, admin clients, or Operations Center. Refer to [manual procedures in the documentation](https://www.ibm.com/docs/en/storage-protect/8.1.25?topic=server-installing-renewed) for those cases.

## Procedure

### 1. Generate a New Certificate

From the admin client (`dsmadmc`):

```shell
CREate CERTificate "certificate_label"
```

- This creates `certificate_label.arm` in the serverâ€™s instance directory.


### 2. Copy the Certificate

- Transfer `certificate_label.arm` to the admin client machine.
- If server and admin client are on the same machine, reference the file path directly in your config.


### 3. Configure the Utility

- Set all parameters in `cert_distribute.ini`.
- Place both script and config in the same directory.


### 4. Ensure Permissions

For Linux:

```shell
chmod +x cert_distribute.sh
```


### 5. Execute the Distribution Script

Execute the script with the appropriate action. Examples:

#### Linux/UNIX:

```shell
./cert_distribute.sh -id <dsmadmc-user-id> -pass <dsmadmc-user-password> -action distribute
```


#### AIX:

```shell
./cert_distribute.ksh -id <dsmadmc-user-id> -pass <dsmadmc-user-password> -action distribute
```


#### Windows:

```powershell
powershell .\cert_distribute.ps1 -id <dsmadmc-user-id> -pass <dsmadmc-user-password> -action distribute
```

- Use single quotes for `id` or `password` containing special characters.


### 6. Monitor Progress

Run the script in **report** mode:

```shell
./cert_distribute.sh -id <id> -pass <password> -action report
```

- The script generates a detailed status report. `Completed` indicates success; `Missed` or `Future` may require additional schedule runs.
- If a client repeatedly fails, manually distribute the certificate:

1. Copy the certificate to the client.
2. Add it using:

```shell
gsk8capicmd_64 -cert -add -label "<New Certificate Label>" -file "<New Certificate File Path>" -db dsmcert.kdb -stashed
```


### 7. Cleanup

After full distribution, remove schedules:

```shell
./cert_distribute.sh -id <id> -pass <password> -action cleanup
```


### 8. Set Default Certificate

Once distribution is confirmed as successful for all clients, set the new certificate as default:

```shell
SET DEFAULTTLSCert <certificate_label>
```


### 9. Restart the Server

To activate the certificate, restart the IBM Storage Protect server.

> **Note:** Restarting will abort any [ongoing backup, restore, or replication sessions](https://www.ibm.com/docs/en/storage-protect/8.1.27?topic=sessions-monitoring).

**Reference:** [Automating the distribution of IBM Storage Protect server certificate to clients](https://www.ibm.com/docs/en/storage-protect/8.1.27?topic=errors-automating-distribution-storage-protect-server-certificate-clients)
